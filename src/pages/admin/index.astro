---
/**
 * Admin Dashboard Home
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';
---

<AdminLayout title="Dashboard" activePage="dashboard">
  <div class="space-y-8">
    <!-- Header -->
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
      <p class="mt-2 text-gray-600">Manage your XR Awards website</p>
    </div>

    <!-- Publish Section -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Publish Changes</h2>
          <p class="text-sm text-gray-600">Deploy your changes to the live site</p>
        </div>
        <button
          id="publishBtn"
          class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
        >
          <span id="publishIcon">üöÄ</span>
          <span id="publishText">Publish Changes</span>
        </button>
      </div>
      
      <!-- Status Message -->
      <div id="publishStatus" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
      
      <!-- Recent Deployments -->
      <div id="recentDeployments" class="mt-4 border-t border-gray-100 pt-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Recent Deployments</h3>
        <div id="deploymentsList" class="space-y-2 text-sm text-gray-600">
          <p class="text-gray-400">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Media Library Card -->
      <a
        href="/admin/media-library/"
        class="bg-white p-6 rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-all"
     >
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">
            üì∏
          </div>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-1">Media Library</h3>
        <p class="text-sm text-gray-600">Upload and manage images</p>
      </a>

      <!-- Categories Card -->
      <a
        href="/admin/categories/"
        class="bg-white p-6 rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-all"
     >
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">
            üìÅ
          </div>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-1">Categories</h3>
        <p class="text-sm text-gray-600">Manage award categories</p>
      </a>

      <!-- Finalists Card -->
      <a
        href="/admin/finalists/"
        class="bg-white p-6 rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-all"
     >
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">
            üèÜ
          </div>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-1">Finalists</h3>
        <p class="text-sm text-gray-600">Manage award finalists</p>
      </a>
    </div>

    <!-- Recent Activity / Quick Actions -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
      <div class="space-y-3">
        <a
          href="/admin/media-library/"
          class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
       >
          <div class="flex items-center space-x-3">
            <span class="text-xl">‚¨ÜÔ∏è</span>
            <span class="font-medium text-gray-900">Upload new media</span>
          </div>
          <span class="text-gray-400">‚Üí</span>
        </a>
        <a
          href="/admin/categories/"
          class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
       >
          <div class="flex items-center space-x-3">
            <span class="text-xl">‚ûï</span>
            <span class="font-medium text-gray-900">Add new category</span>
          </div>
          <span class="text-gray-400">‚Üí</span>
        </a>
        <a
          href="/admin/finalists/"
          class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
       >
          <div class="flex items-center space-x-3">
            <span class="text-xl">üéñÔ∏è</span>
            <span class="font-medium text-gray-900">Add new finalist</span>
          </div>
          <span class="text-gray-400">‚Üí</span>
        </a>
      </div>
    </div>

    <!-- Help Section -->
    <div class="bg-blue-50 rounded-lg border border-blue-200 p-6">
      <h2 class="text-lg font-semibold text-blue-900 mb-2">üìö Getting Started</h2>
      <ul class="space-y-2 text-sm text-blue-800">
        <li>‚Ä¢ Upload images to R2 storage for use on the website</li>
        <li>‚Ä¢ Create and manage award categories</li>
        <li>‚Ä¢ Add finalists and winners to showcase</li>
        <li>‚Ä¢ Click "Publish Changes" to deploy updates to the live site</li>
      </ul>
    </div>
  </div>

  <script>
    import { supabase } from '../../utils/supabase';

    // Get access token passed from server via AdminLayout
    const accessToken = (window as any).__SUPABASE_ACCESS_TOKEN__;

    // Publish functionality
    const publishBtn = document.getElementById('publishBtn') as HTMLButtonElement | null;
    const publishIcon = document.getElementById('publishIcon');
    const publishText = document.getElementById('publishText');
    const publishStatus = document.getElementById('publishStatus');
    const deploymentsList = document.getElementById('deploymentsList');

    function formatDate(dateString: string) {
      const date = new Date(dateString);
      return date.toLocaleString('en-GB', { 
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getStatusBadge(status: string, conclusion: string | null) {
      if (status === 'completed') {
        if (conclusion === 'success') {
          return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚úì Success</span>';
        } else if (conclusion === 'failure') {
          return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">‚úó Failed</span>';
        }
        return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">' + conclusion + '</span>';
      } else if (status === 'in_progress' || status === 'queued') {
        return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">‚è≥ ' + status + '</span>';
      }
      return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">' + status + '</span>';
    }

    async function loadDeployments() {
      try {
        if (!accessToken) {
          throw new Error('Not authenticated');
        }

        const { data, error } = await supabase.functions.invoke('publish', {
          method: 'GET',
          headers: {
            Authorization: 'Bearer ' + accessToken,
          },
        });

        if (error) {
          throw error;
        }
        
        if (data && data.runs && data.runs.length > 0) {
          deploymentsList!.innerHTML = data.runs.map(function(run: any) {
            return '<div class="flex items-center justify-between py-1"><span>' + formatDate(run.created_at) + '</span>' + getStatusBadge(run.status, run.conclusion) + '</div>';
          }).join('');
        } else {
          deploymentsList!.innerHTML = '<p class="text-gray-400">No recent deployments</p>';
        }
      } catch (error) {
        console.error('Load deployments error:', error);
        deploymentsList!.innerHTML = '<p class="text-gray-400">Could not load deployment history</p>';
      }
    }

    function showStatus(message: string, type: 'success' | 'error' | 'info') {
      const colors = {
        success: 'bg-green-50 text-green-800 border border-green-200',
        error: 'bg-red-50 text-red-800 border border-red-200',
        info: 'bg-blue-50 text-blue-800 border border-blue-200'
      };
      publishStatus!.className = 'mt-4 p-3 rounded-lg text-sm ' + colors[type];
      publishStatus!.textContent = message;
      publishStatus!.classList.remove('hidden');
    }

    function setLoading(loading: boolean) {
      if (publishBtn) publishBtn.disabled = loading;
      if (loading) {
        publishIcon!.textContent = '‚è≥';
        publishText!.textContent = 'Publishing...';
      } else {
        publishIcon!.textContent = 'üöÄ';
        publishText!.textContent = 'Publish Changes';
      }
    }

    if (publishBtn) {
      publishBtn.addEventListener('click', async function() {
        setLoading(true);
        publishStatus!.classList.add('hidden');

        try {
          if (!accessToken) {
            showStatus('Not authenticated. Please log in again.', 'error');
            setLoading(false);
            return;
          }

          const { data, error } = await supabase.functions.invoke('publish', {
            method: 'POST',
            body: {
              reason: 'Manual publish from admin dashboard'
            },
            headers: {
              Authorization: 'Bearer ' + accessToken,
            },
          });

          if (error) {
            showStatus(error.message || 'Failed to trigger deployment', 'error');
            setLoading(false);
            return;
          }

          if (data && data.success) {
            showStatus(data.message, 'success');
            // Reload deployments after a short delay to show the new run
            setTimeout(loadDeployments, 3000);
          } else {
            showStatus((data && data.error) || (data && data.details) || 'Failed to trigger deployment', 'error');
          }
        } catch (error) {
          console.error('Publish error:', error);
          showStatus('Network error. Please try again.', 'error');
        } finally {
          setLoading(false);
        }
      });
    }

    // Load deployments on page load
    loadDeployments();
  </script>
</AdminLayout>

