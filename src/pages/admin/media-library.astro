---
/**
 * Admin Media Library Management Page
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';
import Modal from '../../components/admin/Modal.astro';
import { requireAdminAuth } from '../../utils/supabase';

// Secure authentication check
const authResult = await requireAdminAuth(Astro.cookies, Astro.request);

// Redirect if not authenticated
if (!authResult.authenticated) {
  return Astro.redirect(authResult.redirect);
}

const { session } = authResult;
---

<AdminLayout title="Media Library" activePage="media-library" session={session}>
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Media Library</h1>
        <p class="mt-2 text-gray-600">Manage media files with relationships to events, categories, finalists, sponsors, judges, and tags</p>
      </div>
      <button
        id="uploadMediaBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
      >
        + Upload Media
      </button>
    </div>

    <!-- Filter -->
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex flex-wrap gap-4">
        <select id="eventFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Events</option>
        </select>
        <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Categories</option>
        </select>
        <select id="finalistFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Finalists</option>
        </select>
        <select id="sponsorFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Sponsors</option>
        </select>
        <select id="judgeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Judges</option>
        </select>
        <select id="tagFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Tags</option>
        </select>
        <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Types</option>
          <option value="image">Images</option>
          <option value="video">Videos</option>
          <option value="audio">Audio</option>
          <option value="document">Documents</option>
        </select>
      </div>
      <div class="mt-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Search media by filename, title, or description..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
        />
      </div>
    </div>

    <!-- Media Grid -->
    <div id="mediaList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <!-- Loading state -->
      <div class="col-span-full text-center py-12">
        <p class="text-gray-500">Loading media...</p>
      </div>
    </div>

    <!-- Load More Button -->
    <div id="loadMoreContainer" class="hidden text-center mt-8">
      <button
        id="loadMoreBtn"
        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
      >
        Load More
      </button>
      <p id="mediaCount" class="text-sm text-gray-500 mt-2"></p>
    </div>

    <!-- Upload/Edit Modal -->
    <Modal id="mediaModal" title="Upload Media">
      <form id="mediaModalForm" class="space-y-6 max-w-full">
          <input type="hidden" id="mediaId" name="id" />
          
          <!-- File Upload Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">File Upload</h3>

            <div id="fileUploadSection">
              <label for="file" class="block text-sm font-medium text-gray-700 mb-1">
                File *
              </label>
              <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors">
                <div class="space-y-1 text-center">
                  <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <div class="flex text-sm text-gray-600">
                    <label for="file" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-hidden">
                      <span>Upload a file</span>
                      <input id="file" name="file" type="file" class="sr-only" />
                    </label>
                    <p class="pl-1">or drag and drop</p>
                  </div>
                  <p class="text-xs text-gray-500">PNG, JPG, GIF, WebP, MP4, PDF up to 10MB</p>
                </div>
              </div>
              <div id="filePreview" class="mt-4 hidden">
                <img id="previewImage" class="max-w-full h-auto rounded-lg" alt="Preview" />
                <p id="fileName" class="mt-2 text-sm text-gray-600"></p>
              </div>
            </div>
          </div>

          <!-- Media Details Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Media Details</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="min-w-0">
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                  Title
                </label>
                <input
                  type="text"
                  id="title"
                  name="title"
                  class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  placeholder="Optional title for the media"
                />
              </div>
              
              <div class="min-w-0">
                <label for="altText" class="block text-sm font-medium text-gray-700 mb-1">
                  Alt Text
                </label>
                <input
                  type="text"
                  id="altText"
                  name="altText"
                  class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  placeholder="Accessibility description"
                />
              </div>
            </div>

            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                Description
              </label>
              <textarea
                id="description"
                name="description"
                rows="3"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="Optional description..."
              ></textarea>
            </div>

            <div>
              <label class="flex items-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                <input
                  type="checkbox"
                  id="isPublic"
                  name="isPublic"
                  checked
                  class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                />
                <div>
                  <span class="text-sm font-medium text-gray-700">Public</span>
                  <p class="text-xs text-gray-500">Visible to everyone</p>
                </div>
              </label>
            </div>
          </div>

          <!-- Relationships Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Relationships</h3>
            
            <!-- Events -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Events
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <div id="selectedEvents" class="flex flex-wrap gap-2 mb-2"></div>
                <select id="eventSelector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-hidden focus:ring-2 focus:ring-blue-500">
                  <option value="">+ Add an event</option>
                </select>
              </div>
            </div>

            <!-- Categories -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Categories
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <div id="selectedCategories" class="flex flex-wrap gap-2 mb-2"></div>
                <select id="categorySelector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-hidden focus:ring-2 focus:ring-blue-500">
                  <option value="">+ Add a category</option>
                </select>
              </div>
            </div>

            <!-- Finalists -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Finalists
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <div id="selectedFinalists" class="flex flex-wrap gap-2 mb-2"></div>
                <select id="finalistSelector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-hidden focus:ring-2 focus:ring-blue-500">
                  <option value="">+ Add a finalist</option>
                </select>
              </div>
            </div>

            <!-- Sponsors -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Sponsors
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <div id="selectedSponsors" class="flex flex-wrap gap-2 mb-2"></div>
                <select id="sponsorSelector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-hidden focus:ring-2 focus:ring-blue-500">
                  <option value="">+ Add a sponsor</option>
                </select>
              </div>
            </div>

            <!-- Judges -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Judges
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <div id="selectedJudges" class="flex flex-wrap gap-2 mb-2"></div>
                <select id="judgeSelector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-hidden focus:ring-2 focus:ring-blue-500">
                  <option value="">+ Add a judge</option>
                </select>
              </div>
            </div>

            <!-- Tags -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Tags
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <div id="selectedTags" class="flex flex-wrap gap-2 mb-2"></div>
                <select id="tagSelector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-hidden focus:ring-2 focus:ring-blue-500">
                  <option value="">+ Add a tag</option>
                </select>
              </div>
            </div>
          </div>
      </form>
    </Modal>
  </div>
</AdminLayout>

<script>
  let media: any[] = [];
  let availableEvents: any[] = [];
  let availableCategories: any[] = [];
  let availableFinalists: any[] = [];
  let availableSponsors: any[] = [];
  let availableJudges: any[] = [];
  let availableTags: any[] = [];
  
  let selectedEvents: any[] = [];
  let selectedCategories: any[] = [];
  let selectedFinalists: any[] = [];
  let selectedSponsors: any[] = [];
  let selectedJudges: any[] = [];
  let selectedTags: any[] = [];
  
  let filters = { 
    event: '', 
    category: '', 
    finalist: '', 
    sponsor: '', 
    judge: '', 
    tag: '', 
    type: '',
    search: ''
  };

  // Pagination state - server-side pagination
  let currentOffset = 0;
  const itemsPerPage = 50; // Fetch 50 items at a time from server
  let totalCount = 0;
  let isLoading = false;
  let hasMoreItems = false;

  // Load initial data (filters/selectors and first batch of media)
  async function loadAllData() {
    try {
      const [eventsRes, categoriesRes, finalistsRes, sponsorsRes, judgesRes, tagsRes] = await Promise.all([
        fetch('/api/events'),
        fetch('/api/categories'),
        fetch('/api/finalists'),
        fetch('/api/sponsors'),
        fetch('/api/judges'),
        fetch('/api/tags')
      ]);

      const [eventsData, categoriesData, finalistsData, sponsorsData, judgesData, tagsData] = await Promise.all([
        eventsRes.json(),
        categoriesRes.json(),
        finalistsRes.json(),
        sponsorsRes.json(),
        judgesRes.json(),
        tagsRes.json()
      ]);

      availableEvents = eventsData.events || [];
      availableCategories = categoriesData.categories || [];
      availableFinalists = finalistsData.finalists || [];
      availableSponsors = sponsorsData.sponsors || [];
      // Add computed name property for judges
      availableJudges = (judgesData.judges || []).map((judge: any) => ({
        ...judge,
        name: `${judge.first_name} ${judge.last_name}`.trim()
      }));
      availableTags = tagsData.tags || [];

      updateSelectors();
      populateFilters();
      
      // Load first batch of media
      currentOffset = 0;
      media = [];
      await loadMediaBatch();
    } catch (error) {
      console.error('Error loading data:', error);
    }
  }

  // Load a batch of media from the server
  async function loadMediaBatch(resetList = false) {
    try {
      isLoading = true;
      
      // Build query params
      const params = new URLSearchParams({
        limit: itemsPerPage.toString(),
        offset: currentOffset.toString()
      });
      
      // Add search term if present (server-side search)
      if (filters.search) {
        params.append('searchTerm', filters.search);
      }
      
      const mediaRes = await fetch(`/api/media?${params.toString()}`);
      const mediaData = await mediaRes.json();

      const newMedia = (mediaData.media || []).map((item: any) => ({
        ...item,
        // Add computed name property for judges in media items
        judges: item.judges?.map((judge: any) => ({
          ...judge,
          name: `${judge.first_name} ${judge.last_name}`.trim()
        }))
      }));

      // Reset list or append
      media = resetList ? newMedia : [...media, ...newMedia];
      totalCount = mediaData.totalCount || 0;
      hasMoreItems = media.length < totalCount;
      
      renderMedia();
    } catch (error) {
      console.error('Error loading media batch:', error);
    } finally {
      isLoading = false;
    }
  }

  // Update selector dropdowns
  function updateSelectors() {
    updateEventSelector();
    updateCategorySelector();
    updateFinalistSelector();
    updateSponsorSelector();
    updateJudgeSelector();
    updateTagSelector();
  }

  function updateEventSelector() {
    const selector = document.getElementById('eventSelector') as HTMLSelectElement;
    const selectedIds = selectedEvents.map(e => e.id);
    selector.innerHTML = '<option value="">+ Add an event</option>' +
      availableEvents
        .filter(event => !selectedIds.includes(event.id))
        .map(event => `<option value="${event.id}">${event.event_name} (${event.event_year})</option>`)
        .join('');
  }

  function updateCategorySelector() {
    const selector = document.getElementById('categorySelector') as HTMLSelectElement;
    const selectedIds = selectedCategories.map(c => c.id);
    selector.innerHTML = '<option value="">+ Add a category</option>' +
      availableCategories
        .filter(category => !selectedIds.includes(category.id))
        .map(category => `<option value="${category.id}">${category.name}</option>`)
        .join('');
  }

  function updateFinalistSelector() {
    const selector = document.getElementById('finalistSelector') as HTMLSelectElement;
    const selectedIds = selectedFinalists.map(f => f.id);
    selector.innerHTML = '<option value="">+ Add a finalist</option>' +
      availableFinalists
        .filter(finalist => !selectedIds.includes(finalist.id))
        .map(finalist => `<option value="${finalist.id}">${finalist.title}</option>`)
        .join('');
  }

  function updateSponsorSelector() {
    const selector = document.getElementById('sponsorSelector') as HTMLSelectElement;
    const selectedIds = selectedSponsors.map(s => s.id);
    selector.innerHTML = '<option value="">+ Add a sponsor</option>' +
      availableSponsors
        .filter(sponsor => !selectedIds.includes(sponsor.id))
        .map(sponsor => `<option value="${sponsor.name}">${sponsor.name}</option>`)
        .join('');
  }

  function updateJudgeSelector() {
    const selector = document.getElementById('judgeSelector') as HTMLSelectElement;
    const selectedIds = selectedJudges.map(j => j.id);
    selector.innerHTML = '<option value="">+ Add a judge</option>' +
      availableJudges
        .filter(judge => !selectedIds.includes(judge.id))
        .map(judge => `<option value="${judge.id}">${judge.name}</option>`)
        .join('');
  }

  function updateTagSelector() {
    const selector = document.getElementById('tagSelector') as HTMLSelectElement;
    const selectedIds = selectedTags.map(t => t.id);
    selector.innerHTML = '<option value="">+ Add a tag</option>' +
      availableTags
        .filter(tag => !selectedIds.includes(tag.id))
        .map(tag => `<option value="${tag.id}">${tag.name}</option>`)
        .join('');
  }

  // Populate filter dropdowns
  function populateFilters() {
    const eventFilter = document.getElementById('eventFilter') as HTMLSelectElement;
    eventFilter.innerHTML = '<option value="">All Events</option>' +
      availableEvents.map(event => `<option value="${event.id}">${event.event_name} (${event.event_year})</option>`).join('');

    const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
      availableCategories.map(category => `<option value="${category.id}">${category.name}</option>`).join('');

    const finalistFilter = document.getElementById('finalistFilter') as HTMLSelectElement;
    finalistFilter.innerHTML = '<option value="">All Finalists</option>' +
      availableFinalists.map(finalist => `<option value="${finalist.id}">${finalist.title}</option>`).join('');

    const sponsorFilter = document.getElementById('sponsorFilter') as HTMLSelectElement;
    sponsorFilter.innerHTML = '<option value="">All Sponsors</option>' +
      availableSponsors.map(sponsor => `<option value="${sponsor.id}">${sponsor.name}</option>`).join('');

    const judgeFilter = document.getElementById('judgeFilter') as HTMLSelectElement;
    judgeFilter.innerHTML = '<option value="">All Judges</option>' +
      availableJudges.map(judge => `<option value="${judge.id}">${judge.name}</option>`).join('');

    const tagFilter = document.getElementById('tagFilter') as HTMLSelectElement;
    tagFilter.innerHTML = '<option value="">All Tags</option>' +
      availableTags.map(tag => `<option value="${tag.id}">${tag.name}</option>`).join('');
  }

  // Render selected items as badges
  function renderSelectedItems(containerId: string, items: any[], type: string) {
    const container = document.getElementById(containerId)!;
    
    if (items.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-400 italic">None selected</p>';
      return;
    }

    container.innerHTML = items.map(item => `
      <span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
        ${item.name || item.title || item.event_name}
        <button
          type="button"
          onclick="remove${type}('${item.id}')"
          class="hover:bg-blue-200 rounded-full p-0.5 transition-colors"
        >
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </span>
    `).join('');
  }

  // Add/remove functions
  (window as any).addEvent = (eventId: string) => {
    if (!eventId) return;
    const event = availableEvents.find(e => e.id === eventId);
    if (event && !selectedEvents.find(e => e.id === eventId)) {
      selectedEvents.push(event);
      renderSelectedItems('selectedEvents', selectedEvents, 'Event');
      updateEventSelector();
    }
  };

  (window as any).removeEvent = (eventId: string) => {
    selectedEvents = selectedEvents.filter(e => e.id !== eventId);
    renderSelectedItems('selectedEvents', selectedEvents, 'Event');
    updateEventSelector();
  };

  (window as any).addCategory = (categoryId: string) => {
    if (!categoryId) return;
    const category = availableCategories.find(c => c.id === categoryId);
    if (category && !selectedCategories.find(c => c.id === categoryId)) {
      selectedCategories.push(category);
      renderSelectedItems('selectedCategories', selectedCategories, 'Category');
      updateCategorySelector();
    }
  };

  (window as any).removeCategory = (categoryId: string) => {
    selectedCategories = selectedCategories.filter(c => c.id !== categoryId);
    renderSelectedItems('selectedCategories', selectedCategories, 'Category');
    updateCategorySelector();
  };

  (window as any).addFinalist = (finalistId: string) => {
    if (!finalistId) return;
    const finalist = availableFinalists.find(f => f.id === finalistId);
    if (finalist && !selectedFinalists.find(f => f.id === finalistId)) {
      selectedFinalists.push(finalist);
      renderSelectedItems('selectedFinalists', selectedFinalists, 'Finalist');
      updateFinalistSelector();
    }
  };

  (window as any).removeFinalist = (finalistId: string) => {
    selectedFinalists = selectedFinalists.filter(f => f.id !== finalistId);
    renderSelectedItems('selectedFinalists', selectedFinalists, 'Finalist');
    updateFinalistSelector();
  };

  (window as any).addSponsor = (sponsorId: string) => {
    if (!sponsorId) return;
    const sponsor = availableSponsors.find(s => s.id === sponsorId);
    if (sponsor && !selectedSponsors.find(s => s.id === sponsorId)) {
      selectedSponsors.push(sponsor);
      renderSelectedItems('selectedSponsors', selectedSponsors, 'Sponsor');
      updateSponsorSelector();
    }
  };

  (window as any).removeSponsor = (sponsorId: string) => {
    selectedSponsors = selectedSponsors.filter(s => s.id !== sponsorId);
    renderSelectedItems('selectedSponsors', selectedSponsors, 'Sponsor');
    updateSponsorSelector();
  };

  (window as any).addJudge = (judgeId: string) => {
    if (!judgeId) return;
    const judge = availableJudges.find(j => j.id === judgeId);
    if (judge && !selectedJudges.find(j => j.id === judgeId)) {
      selectedJudges.push(judge);
      renderSelectedItems('selectedJudges', selectedJudges, 'Judge');
      updateJudgeSelector();
    }
  };

  (window as any).removeJudge = (judgeId: string) => {
    selectedJudges = selectedJudges.filter(j => j.id !== judgeId);
    renderSelectedItems('selectedJudges', selectedJudges, 'Judge');
    updateJudgeSelector();
  };

  (window as any).addTag = (tagId: string) => {
    if (!tagId) return;
    const tag = availableTags.find(t => t.id === tagId);
    if (tag && !selectedTags.find(t => t.id === tagId)) {
      selectedTags.push(tag);
      renderSelectedItems('selectedTags', selectedTags, 'Tag');
      updateTagSelector();
    }
  };

  (window as any).removeTag = (tagId: string) => {
    selectedTags = selectedTags.filter(t => t.id !== tagId);
    renderSelectedItems('selectedTags', selectedTags, 'Tag');
    updateTagSelector();
  };

  // Get filtered media (client-side filtering of already loaded media)
  // Note: Search is handled server-side, so we don't filter by search here
  function getFilteredMedia() {
    return media.filter(item => {
      if (filters.event && !item.events?.some((e: any) => e.id === filters.event)) return false;
      if (filters.category && !item.categories?.some((c: any) => c.id === filters.category)) return false;
      if (filters.finalist && !item.finalists?.some((f: any) => f.id === filters.finalist)) return false;
      if (filters.sponsor && !item.sponsors?.some((s: any) => s.id === filters.sponsor)) return false;
      if (filters.judge && !item.judges?.some((j: any) => j.id === filters.judge)) return false;
      if (filters.tag && !item.tags?.some((t: any) => t.id === filters.tag)) return false;
      if (filters.type) {
        if (filters.type === 'image' && !item.mime_type.startsWith('image/')) return false;
        if (filters.type === 'video' && !item.mime_type.startsWith('video/')) return false;
        if (filters.type === 'audio' && !item.mime_type.startsWith('audio/')) return false;
        if (filters.type === 'document' && !item.mime_type.includes('pdf')) return false;
      }
      // Search filtering is handled server-side in loadMediaBatch()
      return true;
    });
  }

  // Render media grid
  function renderMedia() {
    const container = document.getElementById('mediaList')!;
    const loadMoreContainer = document.getElementById('loadMoreContainer')!;
    const mediaCount = document.getElementById('mediaCount')!;
    const filteredMedia = getFilteredMedia();

    if (media.length === 0) {
      container.innerHTML = `
        <div class="col-span-full text-center py-12">
          <p class="text-gray-500">No media uploaded yet. Upload your first file!</p>
        </div>
      `;
      loadMoreContainer.classList.add('hidden');
      return;
    }

    if (filteredMedia.length === 0) {
      container.innerHTML = `
        <div class="col-span-full text-center py-12">
          <p class="text-gray-500">No media matches the current filters.</p>
        </div>
      `;
      loadMoreContainer.classList.add('hidden');
      return;
    }

    const mediaHTML = filteredMedia.map(item => `
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-sm transition-shadow">
        <!-- Media Preview -->
        <div class="aspect-square bg-gray-100 flex items-center justify-center">
          ${item.mime_type.startsWith('image/') ? 
            `<img src="${item.file_url}" alt="${item.alt_text || item.title || item.filename}" loading="lazy" class="w-full h-full object-cover" />` :
            item.mime_type.startsWith('video/') ?
            `<video src="${item.file_url}" class="w-full h-full object-cover" muted loading="lazy"></video>` :
            item.mime_type.startsWith('audio/') ?
            `<div class="text-center"><div class="text-4xl mb-2">🎵</div><div class="text-sm text-gray-600">Audio</div></div>` :
            `<div class="text-center"><div class="text-4xl mb-2">📄</div><div class="text-sm text-gray-600">${item.file_extension?.toUpperCase()}</div></div>`
          }
        </div>

        <!-- Media Info -->
        <div class="p-4">
          <h3 class="font-medium text-gray-900 truncate" title="${item.title || item.filename}">
            ${item.title || item.filename}
          </h3>
          <p class="text-xs text-gray-400 mt-1 font-mono">ID: ${item.id}</p>
          <p class="text-sm text-gray-500 mt-1">${item.file_size >= 1000000 ? (item.file_size / 1000 / 1000).toFixed(2) + ' MB' : (item.file_size / 1000).toFixed(2) + ' kB'}</p>
          ${item.alt_text ? `<p class="text-xs text-gray-600 mt-1 truncate" title="${item.alt_text}">${item.alt_text}</p>` : ''}
          
          <!-- File URL -->
          <div class="mt-2 flex items-center gap-1">
            <a href="${item.file_url}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:text-blue-800 truncate flex-1" title="${item.file_url}">
              🔗 View File
            </a>
            <button
              onclick="copyToClipboard('${item.file_url}', this)"
              class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors whitespace-nowrap"
              title="Copy full URL to clipboard"
            >
              Copy URL
            </button>
            <button
              onclick="copyPathToClipboard('${item.file_url}', this)"
              class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors whitespace-nowrap"
              title="Copy relative path to clipboard"
            >
              Copy Path
            </button>
          </div>
          
          <!-- Relationships -->
          <div class="mt-3 space-y-1">
            ${item.events?.length ? `<div class="text-xs text-green-600">Events: ${item.events.map((e: any) => e.event_name).join(', ')}</div>` : ''}
            ${item.categories?.length ? `<div class="text-xs text-blue-600">Categories: ${item.categories.map((c: any) => c.name).join(', ')}</div>` : ''}
            ${item.finalists?.length ? `<div class="text-xs text-purple-600">Finalists: ${item.finalists.map((f: any) => f.title).join(', ')}</div>` : ''}
            ${item.sponsors?.length ? `<div class="text-xs text-orange-600">Sponsors: ${item.sponsors.map((s: any) => s.name).join(', ')}</div>` : ''}
            ${item.judges?.length ? `<div class="text-xs text-indigo-600">Judges: ${item.judges.map((j: any) => j.name).join(', ')}</div>` : ''}
            ${item.tags?.length ? `<div class="text-xs text-gray-600">Tags: ${item.tags.map((t: any) => t.name).join(', ')}</div>` : ''}
          </div>
        </div>

        <!-- Actions -->
        <div class="px-4 pb-4 flex gap-2">
          <button
            onclick="editMedia('${item.id}')"
            class="flex-1 bg-blue-500 text-white text-xs px-3 py-2 rounded hover:bg-blue-600"
          >
            Edit
          </button>
          <button
            onclick="deleteMedia('${item.id}', '${item.filename}')"
            class="flex-1 bg-red-500 text-white text-xs px-3 py-2 rounded hover:bg-red-600"
          >
            Delete
          </button>
        </div>
      </div>
    `).join('');

    container.innerHTML = mediaHTML;

    // Update load more button visibility
    // Show if we have more items to fetch from server (when no client-side filters are hiding items)
    if (hasMoreItems && filteredMedia.length === media.length) {
      loadMoreContainer.classList.remove('hidden');
      const searchText = filters.search ? ` matching "${filters.search}"` : '';
      mediaCount.textContent = `Showing ${media.length} of ${totalCount} items${searchText}`;
    } else {
      loadMoreContainer.classList.add('hidden');
    }
  }

  // Load more media items from server
  async function loadMoreMedia() {
    if (isLoading || !hasMoreItems) return;
    
    const btn = document.getElementById('loadMoreBtn') as HTMLButtonElement;
    const originalText = btn.textContent;
    btn.textContent = 'Loading...';
    btn.disabled = true;

    try {
      // Increment offset and load next batch
      currentOffset += itemsPerPage;
      await loadMediaBatch();
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }

  // Modal controls
  const modal = document.getElementById('mediaModal')!;
  const modalTitle = document.getElementById('mediaModalTitle')!;
  const form = document.getElementById('mediaModalForm') as HTMLFormElement;
  const modalError = document.getElementById('mediaModalError')!;

  function openModal(title: string, isEdit: boolean = false) {
    modalTitle.textContent = title;
    modalError.classList.add('hidden');
    modal.classList.remove('hidden');
    
    if (isEdit) {
      document.getElementById('fileUploadSection')!.style.display = 'none';
    } else {
      document.getElementById('fileUploadSection')!.style.display = 'block';
    }
  }

  function closeModal() {
    modal.classList.add('hidden');
    form.reset();
    (document.getElementById('mediaId') as HTMLInputElement).value = '';
    
    // Reset file input and preview
    const fileInput = document.getElementById('file') as HTMLInputElement;
    const filePreview = document.getElementById('filePreview')!;
    const previewImage = document.getElementById('previewImage') as HTMLImageElement;
    const fileName = document.getElementById('fileName')!;
    
    if (fileInput) fileInput.value = '';
    filePreview.classList.add('hidden');
    previewImage.src = '';
    fileName.textContent = '';
    
    selectedEvents = [];
    selectedCategories = [];
    selectedFinalists = [];
    selectedSponsors = [];
    selectedJudges = [];
    selectedTags = [];
    renderSelectedItems('selectedEvents', selectedEvents, 'Event');
    renderSelectedItems('selectedCategories', selectedCategories, 'Category');
    renderSelectedItems('selectedFinalists', selectedFinalists, 'Finalist');
    renderSelectedItems('selectedSponsors', selectedSponsors, 'Sponsor');
    renderSelectedItems('selectedJudges', selectedJudges, 'Judge');
    renderSelectedItems('selectedTags', selectedTags, 'Tag');
    updateSelectors();
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Load More button
    document.getElementById('loadMoreBtn')?.addEventListener('click', loadMoreMedia);

    // Selector change handlers
    document.getElementById('eventSelector')?.addEventListener('change', (e) => {
      (window as any).addEvent((e.target as HTMLSelectElement).value);
      (e.target as HTMLSelectElement).value = '';
    });

    document.getElementById('categorySelector')?.addEventListener('change', (e) => {
      (window as any).addCategory((e.target as HTMLSelectElement).value);
      (e.target as HTMLSelectElement).value = '';
    });

    document.getElementById('finalistSelector')?.addEventListener('change', (e) => {
      (window as any).addFinalist((e.target as HTMLSelectElement).value);
      (e.target as HTMLSelectElement).value = '';
    });

    document.getElementById('sponsorSelector')?.addEventListener('change', (e) => {
      (window as any).addSponsor((e.target as HTMLSelectElement).value);
      (e.target as HTMLSelectElement).value = '';
    });

    document.getElementById('judgeSelector')?.addEventListener('change', (e) => {
      (window as any).addJudge((e.target as HTMLSelectElement).value);
      (e.target as HTMLSelectElement).value = '';
    });

    document.getElementById('tagSelector')?.addEventListener('change', (e) => {
      (window as any).addTag((e.target as HTMLSelectElement).value);
      (e.target as HTMLSelectElement).value = '';
    });

    // Filter change handlers - just re-render with current loaded media
    document.getElementById('eventFilter')?.addEventListener('change', (e) => {
      filters.event = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    document.getElementById('categoryFilter')?.addEventListener('change', (e) => {
      filters.category = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    document.getElementById('finalistFilter')?.addEventListener('change', (e) => {
      filters.finalist = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    document.getElementById('sponsorFilter')?.addEventListener('change', (e) => {
      filters.sponsor = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    document.getElementById('judgeFilter')?.addEventListener('change', (e) => {
      filters.judge = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    document.getElementById('tagFilter')?.addEventListener('change', (e) => {
      filters.tag = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    document.getElementById('typeFilter')?.addEventListener('change', (e) => {
      filters.type = (e.target as HTMLSelectElement).value;
      renderMedia();
    });

    // Search with debounce for server-side search
    let searchTimeout: ReturnType<typeof setTimeout>;
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      const searchValue = (e.target as HTMLInputElement).value;
      filters.search = searchValue;
      
      // Clear existing timeout
      if (searchTimeout) clearTimeout(searchTimeout);
      
      // Debounce search - wait 500ms after user stops typing
      searchTimeout = setTimeout(async () => {
        // Reset pagination and reload from server with search term
        currentOffset = 0;
        await loadMediaBatch(true);
      }, 500);
    });

    // Modal controls
    document.getElementById('uploadMediaBtn')?.addEventListener('click', () => {
      openModal('Upload Media', false);
    });

    document.getElementById('mediaModalCloseBtn')?.addEventListener('click', closeModal);
    document.getElementById('mediaModalCancelBtn')?.addEventListener('click', closeModal);

    // File preview
    document.getElementById('file')?.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        const preview = document.getElementById('filePreview')!;
        const previewImage = document.getElementById('previewImage') as HTMLImageElement;
        const fileName = document.getElementById('fileName')!;

        if (file.type.startsWith('image/')) {
          previewImage.src = URL.createObjectURL(file);
          previewImage.style.display = 'block';
          preview.classList.remove('hidden');
        } else {
          previewImage.style.display = 'none';
          preview.classList.remove('hidden');
        }
        
        const fileSize = file.size >= 1000000 
          ? (file.size / 1000 / 1000).toFixed(2) + ' MB' 
          : (file.size / 1000).toFixed(2) + ' kB';
        fileName.textContent = `${file.name} (${fileSize})`;
      }
    });

    // Form submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      modalError.classList.add('hidden');

      const formData = new FormData(form);
      const isEdit = !!(formData.get('id') as string);

      if (!isEdit && !formData.get('file')) {
        modalError.textContent = 'Please select a file to upload';
        modalError.classList.remove('hidden');
        return;
      }

      // Show loading state in error area
      modalError.textContent = isEdit ? 'Updating...' : 'Uploading...';
      modalError.classList.remove('hidden');
      modalError.classList.remove('text-red-600');
      modalError.classList.add('text-blue-600');

      try {
        if (isEdit) {
          // Update existing media
          const response = await fetch('/api/media', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: formData.get('id'),
              title: formData.get('title'),
              altText: formData.get('altText'),
              description: formData.get('description'),
              isPublic: (document.getElementById('isPublic') as HTMLInputElement).checked,
              eventIds: selectedEvents.map(e => e.id),
              categoryIds: selectedCategories.map(c => c.id),
              finalistIds: selectedFinalists.map(f => f.id),
              sponsorIds: selectedSponsors.map(s => s.id),
              judgeIds: selectedJudges.map(j => j.id),
              tagIds: selectedTags.map(t => t.id)
            })
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error);

          closeModal();
          // Reset and reload from beginning
          currentOffset = 0;
          await loadMediaBatch(true);
        } else {
          // Upload new media
          const file = formData.get('file') as File;
          const response = await fetch('/api/media', {
            method: 'POST',
            body: JSON.stringify({
              file: await fileToBase64(file),
              filename: file.name,
              mimeType: file.type,
              title: formData.get('title'),
              altText: formData.get('altText'),
              description: formData.get('description'),
              isPublic: (document.getElementById('isPublic') as HTMLInputElement).checked,
              eventIds: selectedEvents.map(e => e.id),
              categoryIds: selectedCategories.map(c => c.id),
              finalistIds: selectedFinalists.map(f => f.id),
              sponsorIds: selectedSponsors.map(s => s.id),
              judgeIds: selectedJudges.map(j => j.id),
              tagIds: selectedTags.map(t => t.id)
            }),
            headers: { 'Content-Type': 'application/json' }
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error);

          closeModal();
          // Reset and reload from beginning
          currentOffset = 0;
          await loadMediaBatch(true);
        }
      } catch (error: any) {
        modalError.textContent = error.message;
        modalError.classList.remove('hidden');
        modalError.classList.remove('text-blue-600');
        modalError.classList.add('text-red-600');
      } finally {
        // Hide loading state
        if (!modalError.textContent || modalError.classList.contains('text-blue-600')) {
          modalError.classList.add('hidden');
        }
      }
    });
  });

  // Helper functions
  async function fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        // Remove the data URL prefix (e.g., "data:image/png;base64,")
        const result = reader.result as string;
        const base64 = result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = error => reject(error);
    });
  }

  // Copy to clipboard function
  (window as any).copyToClipboard = async (text: string, button: HTMLButtonElement) => {
    try {
      await navigator.clipboard.writeText(text);
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.classList.add('bg-green-100', 'text-green-700');
      button.classList.remove('bg-gray-100');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-gray-100');
      }, 2000);
    } catch (error) {
      console.error('Failed to copy:', error);
      alert('Failed to copy URL to clipboard');
    }
  };

  // Copy path to clipboard function (extracts path from full URL)
  (window as any).copyPathToClipboard = async (url: string, button: HTMLButtonElement) => {
    try {
      // Extract path from URL (everything after the domain)
      const urlObj = new URL(url);
      const path = urlObj.pathname;
      
      await navigator.clipboard.writeText(path);
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.classList.add('bg-green-100', 'text-green-700');
      button.classList.remove('bg-gray-100');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-gray-100');
      }, 2000);
    } catch (error) {
      console.error('Failed to copy path:', error);
      alert('Failed to copy path to clipboard');
    }
  };

  // Edit media
  (window as any).editMedia = (id: string) => {
    const item = media.find(m => m.id === id);
    if (!item) return;

    (document.getElementById('mediaId') as HTMLInputElement).value = item.id;
    (document.getElementById('title') as HTMLInputElement).value = item.title || '';
    (document.getElementById('altText') as HTMLInputElement).value = item.alt_text || '';
    (document.getElementById('description') as HTMLTextAreaElement).value = item.description || '';
    (document.getElementById('isPublic') as HTMLInputElement).checked = item.is_public !== false;

    selectedEvents = item.events || [];
    selectedCategories = item.categories || [];
    selectedFinalists = item.finalists || [];
    selectedSponsors = item.sponsors || [];
    selectedJudges = item.judges || [];
    selectedTags = item.tags || [];

    renderSelectedItems('selectedEvents', selectedEvents, 'Event');
    renderSelectedItems('selectedCategories', selectedCategories, 'Category');
    renderSelectedItems('selectedFinalists', selectedFinalists, 'Finalist');
    renderSelectedItems('selectedSponsors', selectedSponsors, 'Sponsor');
    renderSelectedItems('selectedJudges', selectedJudges, 'Judge');
    renderSelectedItems('selectedTags', selectedTags, 'Tag');
    updateSelectors();

    openModal('Edit Media', true);
  };

  // Delete media
  (window as any).deleteMedia = async (id: string, filename: string) => {
    if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis will permanently delete the file from storage and remove all database records.`)) return;

    try {
      console.log('Deleting media:', id);
      const response = await fetch('/api/media', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });

      const result = await response.json();
      console.log('Delete response:', result);
      
      if (!response.ok) {
        throw new Error(result.error || 'Failed to delete media');
      }

      // Show success message
      alert('Media deleted successfully!');
      
      // Reset and reload from beginning
      currentOffset = 0;
      await loadMediaBatch(true);
    } catch (error: any) {
      console.error('Delete error:', error);
      alert('Error deleting media: ' + error.message);
    }
  };

  // Initial load
  loadAllData();
</script>
