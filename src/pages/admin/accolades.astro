---
/**
 * Admin Accolades Management Page
 * Manage hierarchical accolades: Main Award → Type → Accolade
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';
import Modal from '../../components/admin/Modal.astro';
---

<AdminLayout title="Accolades" activePage="accolades">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Accolades</h1>
        <p class="mt-2 text-gray-600">Manage award accolades hierarchy</p>
      </div>
      <button
        id="addRootBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
      >
        + Add Accolade Type
      </button>
    </div>

    <!-- Legend -->
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <p class="text-sm text-gray-500 mb-3">Main award categories (e.g., "XR Healthcare Solution of the Year") are managed in Categories. This page manages the accolade hierarchy linked to those categories.</p>
      <div class="flex flex-wrap gap-6 text-sm">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded bg-emerald-500"></span>
          <span class="text-gray-600">Accolade Type (e.g., A-A. Patient Care and Treatment)</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded bg-amber-500"></span>
          <span class="text-gray-600">Individual Accolade (e.g., A-A01 Surgical Planning)</span>
        </div>
      </div>
    </div>

    <!-- Accolades Tree -->
    <div id="accoladesTree" class="space-y-4">
      <div class="text-center py-12">
        <p class="text-gray-500">Loading accolades...</p>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <Modal id="accoladeModal" title="Add Accolade">
      <form id="accoladeModalForm" class="space-y-4">
        <input type="hidden" id="accoladeId" name="id" />
        <input type="hidden" id="parentId" name="parent_id" />
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="code" class="block text-sm font-medium text-gray-700 mb-1">
              Code *
            </label>
            <input
              type="text"
              id="code"
              name="code"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="e.g., A, A-A, A-A01"
            />
          </div>

          <div>
            <label for="sortOrder" class="block text-sm font-medium text-gray-700 mb-1">
              Sort Order
            </label>
            <input
              type="number"
              id="sortOrder"
              name="sort_order"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="0"
            />
          </div>
        </div>

        <div>
          <label for="accoladeName" class="block text-sm font-medium text-gray-700 mb-1">
            Name *
          </label>
          <input
            type="text"
            id="accoladeName"
            name="name"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            placeholder="e.g., XR Healthcare Solution of the Year"
          />
        </div>

        <div>
          <label for="accoladeDescription" class="block text-sm font-medium text-gray-700 mb-1">
            Description
          </label>
          <textarea
            id="accoladeDescription"
            name="description"
            rows="2"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            placeholder="Optional description..."
          ></textarea>
        </div>

        <div>
          <label class="flex items-center space-x-2">
            <input
              type="checkbox"
              id="isActive"
              name="is_active"
              checked
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <span class="text-sm text-gray-700">Active</span>
          </label>
        </div>
      </form>
    </Modal>
  </div>
</AdminLayout>

<script>
  interface Accolade {
    id: string;
    parent_id: string | null;
    code: string;
    name: string;
    description: string | null;
    sort_order: number;
    is_active: boolean;
    children?: Accolade[];
  }

  let accolades: Accolade[] = [];
  let hierarchy: Accolade[] = [];

  // Get level based on parent chain
  function getLevel(accolade: Accolade): number {
    if (!accolade.parent_id) return 1;
    const parent = accolades.find(a => a.id === accolade.parent_id);
    if (!parent) return 1;
    return getLevel(parent) + 1;
  }

  // Get level color (2 levels only: Type and Individual Accolade)
  function getLevelColor(level: number): string {
    switch (level) {
      case 1: return 'bg-emerald-500';
      case 2: return 'bg-amber-500';
      default: return 'bg-gray-500';
    }
  }

  function getLevelBorder(level: number): string {
    switch (level) {
      case 1: return 'border-l-emerald-500';
      case 2: return 'border-l-amber-500';
      default: return 'border-l-gray-500';
    }
  }

  function getLevelLabel(level: number): string {
    switch (level) {
      case 1: return 'Accolade Type';
      case 2: return 'Individual Accolade';
      default: return '';
    }
  }

  // Render accolades tree
  function renderTree() {
    const container = document.getElementById('accoladesTree')!;
    
    if (hierarchy.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 bg-white border border-gray-200 rounded-lg">
          <p class="text-gray-500">No accolades yet. Click "+ Add Main Award" to create one.</p>
        </div>
      `;
      return;
    }

    container.innerHTML = hierarchy.map(item => renderAccoladeItem(item, 1)).join('');
  }

  function renderAccoladeItem(item: Accolade, level: number): string {
    const hasChildren = item.children && item.children.length > 0;
    const canAddChild = level < 2; // Only types (level 1) can have children
    const levelColor = getLevelColor(level);
    const levelBorder = getLevelBorder(level);
    const levelLabel = getLevelLabel(level);
    const indent = (level - 1) * 24;

    return `
      <div class="accolade-item" data-id="${item.id}" style="margin-left: ${indent}px;">
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-2 border-l-4 ${levelBorder} ${!item.is_active ? 'opacity-50' : ''}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="w-2 h-2 rounded ${levelColor}"></span>
                <span class="text-xs font-medium text-gray-400 uppercase">${levelLabel}</span>
                ${!item.is_active ? '<span class="text-xs text-red-500">(Inactive)</span>' : ''}
              </div>
              <div class="flex items-baseline gap-2">
                <span class="font-mono text-sm text-gray-500">${escapeHtml(item.code)}</span>
                <span class="font-medium text-gray-900">${escapeHtml(item.name)}</span>
              </div>
              ${item.description ? `<p class="text-sm text-gray-600 mt-1">${escapeHtml(item.description)}</p>` : ''}
            </div>
            <div class="flex items-center gap-2 shrink-0">
              ${canAddChild ? `
                <button
                  onclick="addChild('${item.id}')"
                  class="px-3 py-1.5 text-xs text-amber-600 hover:bg-amber-50 rounded transition-colors"
                  title="Add Individual Accolade"
                >
                  + Accolade
                </button>
              ` : ''}
              <button
                onclick="editAccolade('${item.id}')"
                class="px-3 py-1.5 text-xs text-blue-600 hover:bg-blue-50 rounded transition-colors"
              >
                Edit
              </button>
              <button
                onclick="deleteAccolade('${item.id}', '${escapeHtml(item.name)}')"
                class="px-3 py-1.5 text-xs text-red-600 hover:bg-red-50 rounded transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
        ${hasChildren ? item.children!.map(child => renderAccoladeItem(child, level + 1)).join('') : ''}
      </div>
    `;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load accolades
  async function loadAccolades() {
    try {
      const response = await fetch('/api/accolades/');
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      
      accolades = data.accolades || [];
      hierarchy = data.hierarchy || [];
      renderTree();
    } catch (error: any) {
      console.error('Error loading accolades:', error);
      document.getElementById('accoladesTree')!.innerHTML = `
        <div class="text-center py-12 bg-white border border-gray-200 rounded-lg">
          <p class="text-red-500">Error loading accolades: ${error.message}</p>
        </div>
      `;
    }
  }

  // Modal controls
  const modal = document.getElementById('accoladeModal')!;
  const modalTitle = document.getElementById('accoladeModalTitle')!;
  const form = document.getElementById('accoladeModalForm') as HTMLFormElement;
  const modalError = document.getElementById('accoladeModalError')!;

  function openModal(title: string) {
    modalTitle.textContent = title;
    modalError.classList.add('hidden');
    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
    form.reset();
    (document.getElementById('accoladeId') as HTMLInputElement).value = '';
    (document.getElementById('parentId') as HTMLInputElement).value = '';
    (document.getElementById('isActive') as HTMLInputElement).checked = true;
  }

  // Add root (accolade type)
  document.getElementById('addRootBtn')!.addEventListener('click', () => {
    (document.getElementById('parentId') as HTMLInputElement).value = '';
    openModal('Add Accolade Type');
  });

  // Add child (individual accolade under a type)
  (window as any).addChild = (parentId: string) => {
    const parent = accolades.find(a => a.id === parentId);
    if (!parent) return;
    
    (document.getElementById('parentId') as HTMLInputElement).value = parentId;
    openModal(`Add Accolade under ${parent.code}`);
  };

  // Edit accolade
  (window as any).editAccolade = (id: string) => {
    const accolade = accolades.find(a => a.id === id);
    if (!accolade) return;

    const level = getLevel(accolade);
    const levelLabel = getLevelLabel(level);

    (document.getElementById('accoladeId') as HTMLInputElement).value = accolade.id;
    (document.getElementById('parentId') as HTMLInputElement).value = accolade.parent_id || '';
    (document.getElementById('code') as HTMLInputElement).value = accolade.code;
    (document.getElementById('accoladeName') as HTMLInputElement).value = accolade.name;
    (document.getElementById('accoladeDescription') as HTMLTextAreaElement).value = accolade.description || '';
    (document.getElementById('sortOrder') as HTMLInputElement).value = accolade.sort_order?.toString() || '0';
    (document.getElementById('isActive') as HTMLInputElement).checked = accolade.is_active !== false;

    openModal(`Edit ${levelLabel}`);
  };

  // Delete accolade
  (window as any).deleteAccolade = async (id: string, name: string) => {
    const accolade = accolades.find(a => a.id === id);
    const hasChildren = accolades.some(a => a.parent_id === id);
    
    let message = `Are you sure you want to delete "${name}"?`;
    if (hasChildren) {
      message += '\n\nWARNING: This will also delete all children (types and accolades).';
    }
    
    if (!confirm(message)) return;

    try {
      const response = await fetch('/api/accolades/', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id }),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      await loadAccolades();
    } catch (error: any) {
      alert('Error deleting accolade: ' + error.message);
    }
  };

  document.getElementById('accoladeModalCloseBtn')!.addEventListener('click', closeModal);
  document.getElementById('accoladeModalCancelBtn')!.addEventListener('click', closeModal);

  // Form submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    modalError.classList.add('hidden');

    const formData = new FormData(form);
    const id = formData.get('id') as string;
    const parentId = formData.get('parent_id') as string;
    
    const data = {
      id: id || undefined,
      parent_id: parentId || null,
      code: formData.get('code'),
      name: formData.get('name'),
      description: formData.get('description') || null,
      sort_order: formData.get('sort_order') ? parseInt(formData.get('sort_order') as string) : 0,
      is_active: (document.getElementById('isActive') as HTMLInputElement).checked,
    };

    try {
      const response = await fetch('/api/accolades/', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();
      if (!response.ok) throw new Error(result.error);

      closeModal();
      await loadAccolades();
    } catch (error: any) {
      modalError.textContent = error.message;
      modalError.classList.remove('hidden');
    }
  });

  // Initial load
  loadAccolades();
</script>

